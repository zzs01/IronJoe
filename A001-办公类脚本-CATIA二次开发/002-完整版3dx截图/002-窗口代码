Option Explicit

Private Sub BTNCancel_Click()
    End
End Sub

Private Sub BTNConfirm_Click()

    '设置背景颜色
    Dim dblColorArray(2)
    dblColorArray(0) = ScrollBarRed.Value
    dblColorArray(1) = ScrollBarGreen.Value
    dblColorArray(2) = ScrollBarBlue.Value
    
    CATIA.RefreshDisplay = False
        
    On Error Resume Next
    Dim t1 As Date
    t1 = Timer
    
    Dim folderPath1 As String
    folderPath1 = MainForm006.TextBox1.Text
     
    If folderPath1 = "" Then Exit Sub
    
    Dim fs As Object
    Dim fp As Object
    Dim f1 'As Object
    Dim fc As Object
    
    Set fs = CATIA.FileSystem  'CATIA文档系统
    Set fp = fs.GetFolder(folderPath1) '获取输入路径位置
    Set fc = fp.Files
    
    '取出每个文件夹下的cgr文件
    Dim SingleFileList As Variant
    SingleFileList = GetSuffixFile(fc, ".3dxml")
    
    '图片保存位置
    Dim folderPath2 As String
    folderPath2 = MainForm006.TextBox2.Text
    If folderPath2 = "" Then Exit Sub
    
    Dim filePath As String
    
    For Each f1 In SingleFileList
        
        filePath = folderPath1 & "\" & f1
        Call ExportImage.ExportImage(folderPath2, filePath, dblColorArray)
    
    Next
    
    CATIA.RefreshDisplay = True
    
    MsgBox "程序运行结束，请检查，谢谢！" & vbCrLf & "程序运行时间：" & Format$(Timer - t1, "0.00") & "s"

    End

End Sub

Private Sub BTNFolderSelect1_Click()
    Dim filePath As String
    filePath = GetFolderPath
    
    MainForm006.TextBox1.Text = filePath
End Sub

Private Sub BTNFolderSelect2_Click()
    Dim filePath As String
    filePath = GetFolderPath
    
    MainForm006.TextBox2.Text = filePath
End Sub

Private Sub ScrollBarBlue_Change()

    TextBoxBlue.Text = ScrollBarBlue.Value
    
End Sub

Private Sub ScrollBarGreen_Change()

    TextBoxGreen.Text = ScrollBarGreen.Value
    
End Sub

Private Sub ScrollBarRed_Change()

    TextBoxRed.Text = ScrollBarRed.Value
    
End Sub

'Private Sub TextBoxBlue_Change()
'
'    If TextBoxBlue.Value > 255 Then TextBoxBlue.Text = 255
'    If TextBoxBlue.Value < 0 Then TextBoxBlue.Text = 0
'
'    ScrollBarBlue.Value = TextBoxBlue.Text
'
'End Sub
'
'Private Sub TextBoxGreen_Change()
'
'    If TextBoxGreen.Value > 255 Then TextBoxGreen.Text = 255
'    If TextBoxGreen.Value < 0 Then TextBoxGreen.Text = 0
'
'    ScrollBarGreen.Value = TextBoxGreen.Text
'
'End Sub
'
'Private Sub TextBoxRed_Change()
'
'    If TextBoxRed.Value > 255 Then TextBoxRed.Text = 255
'    If TextBoxRed.Value < 0 Then TextBoxRed.Text = 0
'
'    ScrollBarRed.Value = TextBoxRed.Text
'
'End Sub

Function GetFolderPath() As String

'=================================================================================================
' TITLE: BrowseForFolderDialogBox
'
' PURPOSE: Open Window dialog box to choose directory to process.
' Return the choosen path to a variable.
'
' HOW TO USE: strResult = BrowseForFolderDialogBox()
' ==================================================

Const WINDOW_HANDLE = 0
Const NO_OPTIONS = &H10
Dim objShellApp
Dim objFolder
Dim objFldrItem
Dim objPath
Dim strTitle

Set objShellApp = CreateObject("Shell.Application")
Set objFolder = objShellApp.BrowseForFolder(WINDOW_HANDLE, strTitle, NO_OPTIONS)

'获得文件夹的名称
objPath = ""
'*****************************'
''''''''''''''
'当前文件夹名称
''''''''''''''
'Dim BrowseForFolderDialogBox
'BrowseForFolderDialogBox = objPath

'If objFolder Is Nothing Then
'
'    objFolder = ""
'
'End If

'*****************************'

If objFolder Is Nothing Then Exit Function

'文件夹绝对路径
Set objFldrItem = objFolder.Self
objPath = objFldrItem.path

GetFolderPath = CStr(objPath)

Set objShellApp = Nothing
Set objFolder = Nothing
Set objFldrItem = Nothing

End Function

Function GetSuffixFile(ByVal FileVar, ByVal fileSuffix As String) As Variant  'ByVal FileVar As Files

'======================================================'
'***********文件筛选处理，文件夹后缀取出***************'
'======================================================'

Dim file As Object
Dim fileName As String
Dim GetFileList() As Variant

Dim i As Integer

'遍历集合内的文件

For Each file In FileVar
    
    fileName = file.Name
    If InStr(LCase(fileName), fileSuffix) <> 0 Then
        
        i = i + 1
        
        ReDim Preserve GetFileList(1 To i)
        
        GetFileList(i) = fileName

    End If
    
    DoEvents
Next

GetSuffixFile = GetFileList

End Function


Private Sub UserForm_Initialize()

'程序过期限制
If Val(Format(Now, "yyyyMMddHHmmss")) > 20220630000000# Then

    MsgBox "程序已过期，请联系管理员"
    End

End If

    '设置截图尺寸大小
    Dim screenShotHeight As Long
    Dim screenShotWidth As Long
    
    screenShotHeight = 900
    screenShotWidth = 900
    
    Call ExportImage.SetScreenSize(screenShotHeight, screenShotWidth)
End Sub
